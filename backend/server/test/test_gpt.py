import logging
import openai

# 设置 logging
logging.basicConfig(level=logging.DEBUG)


# 初始化你的API密钥
openai.api_key = "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"

def ask_gpt3_5_turbo(args):
    # 使用 ChatCompletion 替代 Completion
    response = openai.ChatCompletion.create(
      model="gpt-3.5-turbo-16k",
      messages=args['messages'],
      temperature=0,
      n=1
    )
    answer = response.choices[0].message['content'].strip()
    return answer

# 使用
system_content = f"""#1.Role: 你是一位有经验的趋势交易图标技术分析师，专门研究股票、货币或商品的价格图形。

#2.Background: 你会得到100根k线的价格数据。数据的顺序分别是时间、开盘价、最高价、最低价、收盘价、交易量。

#3.Goals: 请跟据数据，进行图表分析。判断图表是否包含[震荡收敛]的形态，以及当前K线是否是收敛到爆发的[临界点]。
如果当前K线是[临界点]，则返回“可开仓”状态。并把[边界线]、[临界点]、[突破方向]告诉我。
如果不包含[震荡收敛]的形态，或是当前k线不是[临界点]，则返回“不可开仓”状态。并告诉我原因，例如是否包含[震荡收敛]形态，是否有阻力支撑线，是否有突破等等。

#4.Constrains: 不需要额外的文字描述，不需要与我讨论。只要告诉我结果。

#5.Definition:
[震荡收敛]: 价格在一个不是非常大的区间内上下波动，且波动的幅度越来越小。区间逐渐形成一个收敛的区间。
[边界线]: 价格在收敛的过程中，波动的高点和高点线性回归成的直线称为阻力线，或者波动的低点和低点线性回归成的直线称为支撑线。如果价格突破了阻力线或者支撑线，则被突破的线称之为边界线。请给我线性回归后的阻力或支撑线包含的任意两个价格点(可以是虚构的点)。
[临界点]: 价格逐渐收敛到极限，上下波动幅度逐渐降低，持续一段时间后，突然价格突破了阻力或支撑线。并且此时的成交量相对于收敛时期的成交量呈现放大30%以上。突破边界的K线实体完整穿过边界线，且超过边界一定程度，称为完整突破，此时这根K线称为临界点。给我这根k线的数据。
[突破方向]: 向上或向下。

#6.Examples: 这是一个根据K线数据进行交易条件判断的例子：
input:
[[1698508800000, '34200.00', '34200.00', '34115.50', '34148.40', '4248.434'], [1698512400000, '34148.40', '34148.40', '34082.00', '34138.80', '2285.542'], [1698516000000, '34138.80', '34230.70', '34082.00', '34171.10', '3599.688'], [1698519600000, '34171.20', '34182.70', '34118.20', '34118.30', '1986.771'], [1698523200000, '34118.30', '34150.50', '34098.00', '34129.90', '1983.256'], [1698526800000, '34129.90', '34200.00', '34129.90', '34194.80', '2220.087'], [1698530400000, '34194.80', '34194.90', '34063.00', '34105.90', '2772.884'], [1698534000000, '34106.00', '34121.70', '34070.00', '34086.60', '2423.145'], [1698537600000, '34086.70', '34110.50', '34044.50', '34084.50', '3279.905'], [1698541200000, '34084.80', '34099.40', '33956.10', '34010.50', '6984.558'], [1698544800000, '34010.50', '34038.00', '33970.00', '34037.90', '2619.805'], [1698548400000, '34038.00', '34038.00', '33965.10', '33981.00', '2509.987'], [1698552000000, '33981.00', '34058.40', '33933.00', '34024.50', '4771.844'], [1698555600000, '34024.60', '34046.80', '34008.30', '34038.00', '1797.588'], [1698559200000, '34038.10', '34147.70', '34020.00', '34093.40', '4307.185'], [1698562800000, '34093.50', '34136.90', '34062.30', '34086.00', '2367.951'], [1698566400000, '34086.10', '34280.00', '34082.00', '34257.90', '8436.026'], [1698570000000, '34258.00', '34300.00', '34173.90', '34226.50', '8008.517'], [1698573600000, '34226.50', '34230.00', '34162.40', '34185.50', '3660.918'], [1698577200000, '34185.60', '34349.40', '34171.30', '34272.60', '9159.624'], [1698580800000, '34272.60', '34441.80', '34272.30', '34440.60', '10350.637'], [1698584400000, '34440.70', '34552.30', '34338.20', '34393.90', '16048.892'], [1698588000000, '34393.80', '34534.50', '34336.60', '34496.90', '9195.108'], [1698591600000, '34496.90', '34579.70', '34414.20', '34462.50', '10807.812'], [1698595200000, '34462.60', '34470.40', '34382.00', '34405.60', '5354.753'], [1698598800000, '34405.60', '34773.80', '34386.00', '34575.60', '21789.673'], [1698602400000, '34575.60', '34769.30', '34573.20', '34697.50', '10440.711'], [1698606000000, '34697.40', '34718.20', '34518.50', '34571.50', '7512.073'], [1698609600000, '34571.60', '34650.00', '34537.10', '34588.20', '4329.483'], [1698613200000, '34588.20', '34669.60', '34400.00', '34444.80', '6114.228'], [1698616800000, '34444.70', '34746.70', '34443.30', '34708.20', '8009.719'], [1698620400000, '34708.10', '34713.70', '34457.60', '34528.60', '8040.553'], [1698624000000, '34528.60', '34578.80', '34458.00', '34467.00', '5282.109'], [1698627600000, '34467.10', '34532.80', '34416.00', '34431.30', '4989.917'], [1698631200000, '34431.30', '34431.40', '34179.00', '34328.50', '17365.791'], [1698634800000, '34328.50', '34335.00', '34241.70', '34276.50', '4577.138'], [1698638400000, '34276.60', '34355.90', '34222.30', '34324.20', '5303.021'], [1698642000000, '34324.20', '34358.70', '34223.00', '34261.60', '5929.563'], [1698645600000, '34261.60', '34329.00', '34182.00', '34303.10', '6512.680'], [1698649200000, '34303.20', '34349.00', '34104.00', '34191.70', '14434.341'], [1698652800000, '34191.80', '34449.80', '34161.70', '34385.60', '14576.440'], [1698656400000, '34385.50', '34700.00', '34385.10', '34537.40', '20602.598'], [1698660000000, '34537.40', '34590.00', '34428.40', '34540.90', '10112.582'], [1698663600000, '34540.80', '34677.00', '34477.00', '34627.90', '9457.938'], [1698667200000, '34627.80', '34888.20', '34555.50', '34596.20', '29616.429'], [1698670800000, '34596.30', '34784.90', '34474.00', '34670.80', '18462.707'], [1698674400000, '34670.80', '34850.00', '34559.50', '34618.30', '19090.636'], [1698678000000, '34618.30', '34768.70', '34603.20', '34664.50', '9542.577'], [1698681600000, '34664.50', '34664.50', '34351.20', '34471.10', '15332.054'], [1698685200000, '34471.10', '34477.80', '34050.00', '34316.30', '36356.935'], [1698688800000, '34316.20', '34367.30', '34263.70', '34318.90', '7119.458'], [1698692400000, '34318.90', '34445.00', '34286.30', '34440.00', '7234.533'], [1698696000000, '34440.00', '34447.90', '34320.10', '34426.20', '5290.369'], [1698699600000, '34426.20', '34593.10', '34362.30', '34541.90', '7070.952'], [1698703200000, '34542.00', '34553.20', '34458.00', '34475.60', '4435.341'], [1698706800000, '34475.70', '34518.60', '34451.80', '34483.80', '3145.239'], [1698710400000, '34483.80', '34620.70', '34455.00', '34525.50', '9001.883'], [1698714000000, '34525.50', '34552.70', '34400.20', '34458.90', '6474.087'], [1698717600000, '34458.90', '34478.30', '34269.80', '34361.00', '8892.128'], [1698721200000, '34361.10', '34390.60', '34206.10', '34219.90', '8040.682'], [1698724800000, '34219.90', '34296.60', '34186.70', '34240.70', '6462.549'], [1698728400000, '34240.60', '34345.50', '34160.70', '34285.20', '7989.908'], [1698732000000, '34285.20', '34360.00', '34137.60', '34255.90', '10448.176'], [1698735600000, '34256.00', '34306.90', '34080.00', '34151.90', '12940.934'], [1698739200000, '34151.90', '34437.80', '34016.80', '34414.00', '27196.146'], [1698742800000, '34414.10', '34478.10', '34352.90', '34428.00', '9808.251'], [1698746400000, '34428.10', '34470.00', '34366.00', '34454.00', '5982.656'], [1698750000000, '34453.90', '34563.60', '34404.00', '34504.00', '10132.412'], [1698753600000, '34504.10', '34533.10', '34278.60', '34316.50', '15372.685'], [1698757200000, '34316.50', '34355.00', '34152.40', '34227.00', '14365.287'], [1698760800000, '34227.00', '34382.90', '34133.70', '34331.00', '19754.519'], [1698764400000, '34331.10', '34386.70', '34160.40', '34290.20', '15320.762'], [1698768000000, '34290.30', '34546.60', '34240.00', '34445.00', '16091.451'], [1698771600000, '34445.10', '34453.90', '34366.40', '34397.30', '6785.959'], [1698775200000, '34397.30', '34516.00', '34353.60', '34491.60', '6893.094'], [1698778800000, '34491.60', '34632.00', '34447.90', '34553.50', '14961.685'], [1698782400000, '34553.60', '34740.00', '34530.50', '34651.70', '14667.640'], [1698786000000, '34651.70', '34744.70', '34439.50', '34494.00', '12136.259'], [1698789600000, '34494.00', '34660.00', '34455.60', '34571.70', '6743.303'], [1698793200000, '34571.70', '34677.00', '34528.50', '34651.40', '5988.111'], [1698796800000, '34651.40', '34684.00', '34506.70', '34522.30', '11707.408'], [1698800400000, '34522.30', '34575.00', '34475.30', '34507.00', '5253.835'], [1698804000000, '34507.00', '34512.00', '34434.50', '34466.20', '4224.729'], [1698807600000, '34466.20', '34482.40', '34406.40', '34430.00', '4796.034'], [1698811200000, '34429.90', '34484.00', '34400.00', '34456.60', '4147.725'], [1698814800000, '34456.60', '34459.90', '34342.50', '34364.90', '6196.707'], [1698818400000, '34365.00', '34434.40', '34330.40', '34422.90', '4858.899'], [1698822000000, '34422.90', '34520.00', '34404.80', '34463.90', '5804.372'], [1698825600000, '34464.00', '34497.00', '34424.90', '34454.00', '3729.912'], [1698829200000, '34454.00', '34515.10', '34424.60', '34499.90', '3565.078'], [1698832800000, '34500.00', '34502.00', '34366.00', '34387.60', '5941.977'], [1698836400000, '34387.50', '34469.90', '34354.00', '34442.90', '6427.611'], [1698840000000, '34442.90', '34949.60', '34355.00', '34825.40', '37462.012'], [1698843600000, '34825.40', '35249.00', '34400.00', '34612.70', '97543.174'], [1698847200000, '34612.80', '34676.70', '34076.00', '34184.60', '42238.952'], [1698850800000, '34184.20', '34323.20', '34164.10', '34296.90', '18166.652'], [1698854400000, '34296.90', '34559.40', '34288.80', '34458.40', '18477.224'], [1698858000000, '34458.40', '34544.00', '34343.00', '34526.80', '13245.409'], [1698861600000, '34527.00', '34750.00', '34450.30', '34579.30', '27598.918'], [1698865200000, '34579.30', '34730.50', '34498.00', '34564.30', '17584.952'], [1698868800000, '34564.10', '35599.00', '34538.60', '35493.70', '50975.817']]

output：
状态: 可开仓
边界线: [[1698667200000, '34688.00'],[1698668100000, '34850.00']]
临界点: [1698868800000, '34564.10', '34698.00', '34538.60', '34653.60', '4125.423']
突破方向: 向上

#7.Workflows:
1. 先对价格波动的高点和高点、低点和低点进行线性回归，得到阻力和支撑线。
2. 对价格波动的atr、布林带、平均线进行分析。找到一个合理的波动界定，判断出正常震荡波动的条件和小幅波动的条件。
3. 判断最近一段K线的价格组合是否符合条件: 是否先在阻力和支撑线附近进行小幅波动，然后突然放大波动并且K线实体穿过边界线，伴有成交量放大。

"""

user_content = f"""[[1697040000000, '26769.20', '26784.40', '26601.60', '26672.80', '37081.921'], [1697043600000, '26672.80', '26712.00', '26525.00', '26626.30', '27376.191'], [1697047200000, '26626.30', '26708.80', '26572.70', '26682.50', '13958.941'], [1697050800000, '26682.50', '26788.00', '26668.30', '26753.70', '13691.414'], [1697054400000, '26753.80', '26769.80', '26680.00', '26714.30', '7145.305'], [1697058000000, '26714.40', '26759.50', '26666.00', '26721.50', '4607.346'], [1697061600000, '26721.40', '26794.40', '26706.40', '26777.00', '5799.412'], [1697065200000, '26777.00', '26879.70', '26746.00', '26864.50', '11210.758'], [1697068800000, '26864.50', '26880.00', '26788.40', '26794.00', '7844.656'], [1697072400000, '26794.00', '26799.60', '26722.40', '26766.10', '6881.223'], [1697076000000, '26766.00', '26939.00', '26741.10', '26889.90', '10369.167'], [1697079600000, '26890.00', '26904.20', '26814.50', '26836.10', '5572.807'], [1697083200000, '26836.00', '26839.30', '26801.40', '26809.40', '3266.026'], [1697086800000, '26809.40', '26866.00', '26768.80', '26866.00', '5383.150'], [1697090400000, '26865.90', '26909.90', '26822.90', '26852.50', '7118.724'], [1697094000000, '26852.40', '26864.40', '26789.50', '26799.40', '6767.045'], [1697097600000, '26799.30', '26811.20', '26751.50', '26788.40', '7516.014'], [1697101200000, '26788.50', '26813.70', '26650.00', '26732.10', '16476.907'], [1697104800000, '26732.10', '26774.60', '26719.50', '26746.20', '7571.487'], [1697108400000, '26746.20', '26856.50', '26708.60', '26827.40', '9621.480'], [1697112000000, '26827.40', '26845.80', '26741.90', '26817.00', '13828.047'], [1697115600000, '26817.00', '26853.90', '26667.20', '26746.80', '14828.696'], [1697119200000, '26746.70', '26767.50', '26621.60', '26690.20', '13925.017'], [1697122800000, '26690.30', '26724.90', '26606.20', '26665.40', '9760.826'], [1697126400000, '26665.40', '26800.00', '26543.10', '26665.10', '24639.559'], [1697130000000, '26665.20', '26682.00', '26534.80', '26630.70', '19183.628'], [1697133600000, '26630.70', '26719.90', '26585.00', '26648.70', '8483.278'], [1697137200000, '26648.60', '26734.10', '26614.50', '26700.30', '5962.546'], [1697140800000, '26700.20', '26749.00', '26695.00', '26734.40', '4757.541'], [1697144400000, '26734.40', '26754.90', '26695.50', '26745.60', '3879.125'], [1697148000000, '26745.60', '26767.20', '26716.90', '26739.00', '3093.629'], [1697151600000, '26738.90', '26755.50', '26692.00', '26744.00', '3548.462'], [1697155200000, '26744.00', '26849.60', '26733.90', '26818.00', '10020.750'], [1697158800000, '26818.00', '26869.70', '26777.10', '26781.60', '6435.381'], [1697162400000, '26781.70', '26800.00', '26771.60', '26795.30', '3274.336'], [1697166000000, '26795.30', '26823.70', '26756.30', '26769.50', '4271.401'], [1697169600000, '26769.50', '26796.00', '26765.30', '26792.60', '2480.583'], [1697173200000, '26792.60', '26814.90', '26770.00', '26809.40', '3021.862'], [1697176800000, '26809.30', '26847.60', '26786.90', '26796.60', '3953.349'], [1697180400000, '26796.50', '26929.00', '26796.50', '26857.80', '13082.375'], [1697184000000, '26857.90', '26892.30', '26779.00', '26783.00', '7694.777'], [1697187600000, '26783.10', '26813.60', '26722.20', '26725.80', '7586.408'], [1697191200000, '26725.70', '26776.70', '26725.70', '26766.10', '3997.227'], [1697194800000, '26766.20', '26843.20', '26766.20', '26809.90', '6719.788'], [1697198400000, '26810.00', '26925.00', '26751.00', '26920.00', '14812.825'], [1697202000000, '26920.10', '26972.80', '26820.00', '26843.00', '14417.305'], [1697205600000, '26843.00', '26843.00', '26722.60', '26745.40', '11958.083'], [1697209200000, '26745.30', '26774.00', '26670.10', '26693.00', '11685.236'], [1697212800000, '26692.90', '26797.90', '26688.10', '26786.00', '9102.618'], [1697216400000, '26786.00', '26788.40', '26675.00', '26756.90', '7685.813'], [1697220000000, '26756.90', '26777.50', '26720.00', '26734.70', '3701.167'], [1697223600000, '26734.60', '26771.40', '26709.20', '26768.90', '3936.790'], [1697227200000, '26769.00', '27098.00', '26733.30', '26967.80', '25278.653'], [1697230800000, '26967.80', '27120.80', '26830.00', '27005.50', '37058.099'], [1697234400000, '27005.40', '27066.50', '26737.10', '26813.90', '22625.751'], [1697238000000, '26813.90', '26849.80', '26746.00', '26849.80', '8421.577'], [1697241600000, '26849.70', '26889.40', '26837.50', '26879.90', '4786.684'], [1697245200000, '26879.90', '26918.40', '26828.50', '26900.10', '4446.461'], [1697248800000, '26900.00', '26919.70', '26875.60', '26889.70', '3085.816'], [1697252400000, '26889.70', '26986.40', '26889.70', '26918.20', '7332.030'], [1697256000000, '26918.20', '26922.90', '26886.50', '26896.50', '2597.856'], [1697259600000, '26896.50', '26926.40', '26871.00', '26874.20', '3785.872'], [1697263200000, '26874.20', '26886.10', '26842.80', '26851.10', '5253.197'], [1697266800000, '26851.10', '26863.80', '26828.40', '26860.50', '3117.496'], [1697270400000, '26860.40', '26874.50', '26835.00', '26858.00', '2832.849'], [1697274000000, '26858.00', '26874.30', '26858.00', '26870.70', '1799.541'], [1697277600000, '26870.70', '26892.70', '26851.70', '26863.20', '2619.577'], [1697281200000, '26863.20', '26867.10', '26835.70', '26860.10', '2111.926'], [1697284800000, '26860.10', '26883.80', '26837.60', '26882.30', '2403.592'], [1697288400000, '26882.30', '26902.00', '26867.20', '26894.70', '3851.673'], [1697292000000, '26894.70', '26897.80', '26856.70', '26874.30', '2240.876'], [1697295600000, '26874.30', '26930.00', '26864.90', '26927.90', '4788.075'], [1697299200000, '26927.90', '26937.90', '26888.60', '26914.80', '4872.205'], [1697302800000, '26914.80', '26917.70', '26869.90', '26875.10', '2838.708'], [1697306400000, '26875.00', '26877.60', '26853.50', '26858.50', '2498.220'], [1697310000000, '26858.50', '26867.00', '26835.10', '26851.50', '2770.009'], [1697313600000, '26851.50', '26852.10', '26800.00', '26831.80', '3621.159'], [1697317200000, '26831.90', '26869.60', '26773.10', '26806.50', '4864.909'], [1697320800000, '26806.50', '26843.90', '26806.40', '26832.70', '2022.256'], [1697324400000, '26832.70', '26855.90', '26832.60', '26836.30', '1623.794'], [1697328000000, '26836.40', '26842.50', '26801.00', '26835.00', '2461.777'], [1697331600000, '26835.00', '26896.30', '26831.60', '26876.50', '3662.653'], [1697335200000, '26876.60', '26891.00', '26856.50', '26870.50', '1980.944'], [1697338800000, '26870.50', '26894.20', '26861.40', '26871.40', '2621.148'], [1697342400000, '26871.40', '26879.70', '26858.80', '26873.10', '1822.333'], [1697346000000, '26873.20', '26875.00', '26866.70', '26868.30', '736.925'], [1697349600000, '26868.40', '26868.50', '26860.00', '26868.50', '913.307'], [1697353200000, '26868.50', '26872.70', '26858.70', '26872.70', '980.083'], [1697356800000, '26872.70', '26899.90', '26868.50', '26895.00', '2512.020'], [1697360400000, '26894.90', '26909.60', '26883.00', '26890.40', '2252.110'], [1697364000000, '26890.40', '26890.40', '26878.10', '26880.90', '1104.310'], [1697367600000, '26880.80', '26880.90', '26830.10', '26840.40', '3862.290'], [1697371200000, '26840.50', '26840.50', '26813.10', '26824.20', '3195.809'], [1697374800000, '26824.30', '26958.00', '26790.40', '26849.70', '16930.298'], [1697378400000, '26849.70', '26909.20', '26842.90', '26861.80', '3395.669'], [1697382000000, '26861.80', '26898.00', '26838.70', '26885.60', '3157.155'], [1697385600000, '26885.70', '26918.50', '26880.00', '26916.00', '3395.609'], [1697389200000, '26916.00', '27013.50', '26905.50', '26969.50', '12938.397'], [1697392800000, '26969.50', '27050.00', '26943.00', '27046.10', '9142.711'], [1697396400000, '27046.10', '27073.00', '26970.40', '27030.10', '8042.933'], [1697400000000, '27030.10', '27456.10', '27000.90', '27193.90', '31110.470']]"""
answer = ask_gpt3_5_turbo(
  {
    'messages': [
          {"role": "system", "content": system_content},
          {"role": "assistant", "content": "我准备好了。"},
          {"role": "user", "content": user_content}
      ],
  })
print(answer)